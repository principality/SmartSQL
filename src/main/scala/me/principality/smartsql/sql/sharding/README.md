# 分片的实现

## 思路

分片的方法有多种，需要抽象其实现流程

- 获取分片的方法，初始化分片的处理器
- 查询/更新/插入/删除，根据分片方法分配到不同的片上
  - 根据不同的分片方法调用分片的实现方法
  - 计划支持的分片策略：
    1. 按表名指定目标数据库；
    2. 按主键Hash分片；
    3. 按主键范围分片；
  - 按主键分片，可以通过建立索引，即业务字段到键值的映射关系
    - ?
- 合并从一个或多个分片获得最终结果

## 组件

### util

对分片方法实现的支撑算法

- range: 指定分片算法
  - auto-increase-id / range，分区算法
- keygen: 键分片算法
  - snowflake按主键中的服务器编号获得目标服务器
  - 全局服务可以按HASH进行分配

### merge

完成分片的计算后，需要把结果进行合并

### meta

记录分片的表信息
- 分片的列表
- 分片的方法，以及相应的参数

先用model.json文件进行配置，计划将来该部分实现放到MetaRepository中

## 二次分片（扩容）

### name
根据表名指定目标的服务器，常见的分库策略，从业务维度进行库切分，适用于表多业务多、但单表的数据量有限的情况

### range
range采用volume式增长进行管理，range是假设读多写少且整体数据读压力均匀情况下的分片策略

### hash
hash是针对单表数据很多（如超过一千万）的压力情况提出的解决方案

hash某个片下面的数据量会持续增加，通常采取一分二的策略进行扩容，vitess的做法是先把数据一分二拷贝到两台服务器上，然后锁定原数据（只读），
把流量切换到新的两台服务器上，整个过程通过一系列的指令进行，需要服务器实现动态的meta管理、数据可控同步拷贝等基础功能

另外一种做法是预设好的服务器数量，如预计业务会从10台设备持续增长到100台机器，则在原来10台设备上一开始就按100台进行分片，随着服务器的压力增加，
则把原来1台服务器承担的压力逐步分摊到多台上

### 常见的业务数据读写维度

根据业务情况选择分布方案

- 读写比例
- 读写分布 

## 服务器升级思路

### 第一次扩容

增加服务器的计算能力，实现计算业务的增强
- 从单服务器到主从服务器(如单主压力大，可以实现多主)
- 使用SmartSQL基于从库实现计算查询(如果SmartSQL启动了缓冲索引，还需实现从MySQL binlog同步的缓存索引功能)

### 第二次扩容

实现服务能力的线性扩展，持续提升处理能力
- 从主从服务器到分布式中间件
- 使用SmartSQL支持分布式中间件的分库分表策略，实现分布式计算

### 第三次扩容

简化整体架构，使用SmartSQL实现一体化的服务能力线性扩展